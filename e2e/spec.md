# E2E テスト仕様書

## 概要

動画管理 Web アプリケーション（Go バックエンド + React フロントエンド）の E2E テスト仕様。Playwright を使用して全機能をカバーする。

### テスト対象アプリケーション

- **フロントエンド**: React + TypeScript（Vite ビルド、TanStack Query、Tailwind CSS v4）
- **バックエンド**: Go（chi ルーター、SQLite + FTS5）
- **ページ構成**: 一覧ページ（`/`）、詳細ページ（`/videos/:id`）

### テストデータ仕様

Import API（`POST /api/v1/import`）でテストデータを投入する。JSON 形式は以下の通り:

```json
[
  {
    "id": "video-1",
    "title": "テスト動画1 サンプル",
    "url": "https://example.com/video-1",
    "date": "2024-01-15",
    "actors": ["出演者A", "出演者B"],
    "tags": ["タグ1", "タグ2"],
    "jpg": "/video-1/thumb.jpg",
    "pictures_dir": "/video-1/pictures",
    "formats": {
      "1080p": "/video-1/1080p.mp4",
      "720p": "/video-1/720p.mp4"
    }
  },
  {
    "id": "video-2",
    "title": "テスト動画2",
    "url": "https://example.com/video-2",
    "date": "2024-02-20",
    "actors": ["出演者C"],
    "tags": ["タグ3"],
    "jpg": "/video-2/thumb.jpg",
    "pictures_dir": "/video-2/pictures",
    "formats": {
      "720p": "/video-2/720p.mp4"
    }
  },
  {
    "id": "video-3",
    "title": "テスト動画3 空データ",
    "url": "",
    "date": "2024-03-10",
    "actors": [],
    "tags": [],
    "jpg": "/video-3/thumb.jpg",
    "pictures_dir": "",
    "formats": {}
  }
]
```

#### テストデータのカバレッジマトリクス

| フィールド | video-1（複数） | video-2（1つ） | video-3（空） |
|-----------|----------------|---------------|-------------|
| formats | 1080p, 720p | 720p | なし |
| actors | 出演者A, 出演者B | 出演者C | なし |
| tags | タグ1, タグ2 | タグ3 | なし |
| pictures | 3枚（要メディアファイル） | 1枚 | 0枚 |
| url | あり | あり | 空文字列 |

### セレクタ・ラベル一覧

| 要素 | セレクタ / テキスト |
|------|-------------------|
| 検索バー | `input[placeholder="検索..."]` |
| タグフィルタ | `#tag-filter` |
| 出演者フィルタ | `#actor-filter` |
| フィルタ初期値 | テキスト `すべて` |
| クラウドトグル（動画のみ） | `button[aria-label="動画のみ表示中"]` |
| クラウドトグル（全表示） | `button[aria-label="全て表示中"]` |
| 星フィルタ | `[role="group"][aria-label="星フィルタ"]` |
| 星フィルタボタン | `button[aria-label="★Nフィルタ"]` (N=1-5) |
| 星評価 | `[role="group"][aria-label="評価"]` |
| 星評価ボタン | `button[aria-label="★N"]` (N=1-5) |
| 前ページボタン | `button:text("前へ")` |
| 次ページボタン | `button:text("次へ")` |
| ページ表示 | テキスト `{page} / {totalPages}` |
| ダークモード切替 | `button[aria-label="ダークモードに切替"]` |
| ライトモード切替 | `button[aria-label="ライトモードに切替"]` |
| 外部リンク | `a:text("外部リンク")` |
| 画質セレクタ | `#format-select` |
| 画像 alt | `Picture 1`, `Picture 2`, ... |
| 詳細ページ見出し | `h2:text("出演者")`, `h2:text("タグ")`, `h2:text("画像")` |

---

## 機能一覧

| # | 機能 | ページ | 関連コンポーネント | API |
|---|------|-------|-------------------|-----|
| 1 | 動画一覧表示 | `/` | VideoCard | `GET /api/v1/videos` |
| 2 | 全文検索 | `/` | SearchBar | `GET /api/v1/videos?q=` |
| 3 | タグフィルタ | `/` | FilterPanel | `GET /api/v1/videos?tag=` |
| 4 | 出演者フィルタ | `/` | FilterPanel | `GET /api/v1/videos?actor=` |
| 5 | ページネーション | `/` | Pagination | `GET /api/v1/videos?page=` |
| 6 | 動画詳細表示 | `/videos/:id` | VideoDetailPage | `GET /api/v1/videos/:id` |
| 7 | 動画再生 | `/videos/:id` | VideoPlayer | メディア配信 |
| 8 | 画質切替 | `/videos/:id` | VideoPlayer | メディア配信 |
| 9 | 画像ギャラリー | `/videos/:id` | ImageGallery | `GET /api/v1/videos/:id/pictures` |
| 10 | Lightbox 表示 | `/videos/:id` | ImageGallery | − |
| 11 | 星評価 | 両ページ | StarRating | `PUT/DELETE /api/v1/ratings/{videoID}` |
| 12 | テーマ切替 | 全ページ | ThemeToggle | − |
| 13 | URL 状態管理 | `/` | − | − |
| 14 | SPA ナビゲーション | 全ページ | React Router | − |
| 15 | 星フィルタ | `/` | FilterPanel | `GET /api/v1/videos?min_rating=` |

---

## テストシナリオ

### S: 検索

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| S-1 | キーワード検索で一致する動画が表示される | テストデータ投入済み | 検索バーに「サンプル」を入力 | video-1 のみ表示される |
| S-2 | 検索結果が0件の場合の表示 | テストデータ投入済み | 検索バーに「存在しない」を入力 | 動画カードが表示されない |
| S-3 | 検索クエリをクリアすると全件表示に戻る | S-1 実行後 | 検索バーをクリアする | 全動画が表示される |
| S-4 | 検索がデバウンスされる（300ms） | テストデータ投入済み | 検索バーに素早く「テ」「ス」「ト」を入力 | 最終入力後 300ms 経過してから API リクエストが発行される |
| S-5 | 検索時にページが1にリセットされる | 2ページ目を表示中 | 検索バーにキーワードを入力 | ページが1に戻る |
| S-6 | 出演者名で検索できる | テストデータ投入済み | 検索バーに「出演者A」を入力 | video-1 が表示される（FTS に出演者名が含まれるため） |
| S-7 | タグ名で検索できる | テストデータ投入済み | 検索バーに「タグ3」を入力 | video-2 が表示される（FTS にタグ名が含まれるため） |

### F: フィルタリング（タグ・出演者）

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| F-1 | タグフィルタの初期状態 | テストデータ投入済み | 一覧ページを表示 | タグフィルタが「すべて」に設定されている |
| F-2 | タグで絞り込み | テストデータ投入済み | タグフィルタで「タグ1」を選択 | video-1 のみ表示される |
| F-3 | タグフィルタをリセット | F-2 実行後 | タグフィルタで「すべて」を選択 | 全動画が表示される |
| F-4 | タグフィルタのオプション一覧 | テストデータ投入済み | タグフィルタのドロップダウンを開く | 「すべて」「タグ1」「タグ2」「タグ3」が表示される |
| F-5 | 出演者フィルタの初期状態 | テストデータ投入済み | 一覧ページを表示 | 出演者フィルタが「すべて」に設定されている |
| F-6 | 出演者で絞り込み | テストデータ投入済み | 出演者フィルタで「出演者C」を選択 | video-2 のみ表示される |
| F-7 | 出演者フィルタをリセット | F-6 実行後 | 出演者フィルタで「すべて」を選択 | 全動画が表示される |
| F-8 | 出演者フィルタのオプション一覧 | テストデータ投入済み | 出演者フィルタのドロップダウンを開く | 「すべて」「出演者A」「出演者B」「出演者C」が表示される |
| F-9 | フィルタ変更時にページが1にリセットされる | 2ページ目を表示中 | タグフィルタを変更 | ページが1に戻る |
| F-10 | タグが0件の動画はタグフィルタで除外される | テストデータ投入済み | タグフィルタで「タグ1」を選択 | video-3（タグなし）は表示されない |
| F-11 | 出演者が0人の動画は出演者フィルタで除外される | テストデータ投入済み | 出演者フィルタで「出演者A」を選択 | video-3（出演者なし）は表示されない |

### C: 複合フィルタ

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| C-1 | 検索 + タグフィルタ | テストデータ投入済み | 検索バーに「テスト」を入力し、タグフィルタで「タグ1」を選択 | video-1 のみ表示される |
| C-2 | 検索 + 出演者フィルタ | テストデータ投入済み | 検索バーに「テスト」を入力し、出演者フィルタで「出演者C」を選択 | video-2 のみ表示される |
| C-3 | タグ + 出演者フィルタ | テストデータ投入済み | タグフィルタで「タグ1」、出演者フィルタで「出演者A」を選択 | video-1 のみ表示される |
| C-4 | 検索 + タグ + 出演者フィルタ | テストデータ投入済み | 検索「テスト」、タグ「タグ1」、出演者「出演者A」を設定 | video-1 のみ表示される |
| C-5 | 一致しない複合フィルタ | テストデータ投入済み | タグ「タグ1」、出演者「出演者C」を選択 | 結果が0件になる |
| C-6 | 複合フィルタの一部を解除 | C-4 実行後 | タグフィルタを「すべて」に戻す | 検索「テスト」+ 出演者「出演者A」の結果が表示される |

### P: ページネーション

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| P-1 | ページ番号の表示 | テストデータ投入済み | 一覧ページを表示 | `1 / 1` のように表示される |
| P-2 | 次ページへ遷移 | 複数ページのデータが存在 | 「次へ」ボタンをクリック | 2ページ目が表示され、URL の `page` パラメータが `2` になる |
| P-3 | 前ページへ遷移 | P-2 実行後 | 「前へ」ボタンをクリック | 1ページ目に戻る |
| P-4 | 1ページ目で「前へ」が無効 | テストデータ投入済み | 1ページ目を表示 | 「前へ」ボタンが `disabled` になっている |
| P-5 | 最終ページで「次へ」が無効 | テストデータ投入済み | 最終ページを表示 | 「次へ」ボタンが `disabled` になっている |
| P-6 | フィルタ適用後のページネーション | 複数ページのデータが存在、フィルタ適用で1ページ分 | タグフィルタを適用 | ページが1にリセットされ、ページ表示が更新される |

### N: ナビゲーション・ページ遷移

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| N-1 | 動画カードクリックで詳細ページへ遷移 | テストデータ投入済み | video-1 のカードをクリック | `/videos/video-1` に遷移し、詳細ページが表示される |
| N-2 | 動画タイトルクリックで詳細ページへ遷移 | テストデータ投入済み | video-1 のタイトルリンクをクリック | `/videos/video-1` に遷移する |
| N-3 | ブラウザバックで一覧ページに戻る | N-1 実行後 | ブラウザの戻るボタンを押す | 一覧ページに戻る |
| N-4 | 存在しない動画IDへのアクセス | − | `/videos/nonexistent` にアクセス | エラー状態が表示される |
| N-5 | SPA フォールバック | − | `/videos/video-1` に直接アクセス | 詳細ページが正常に表示される（SPA フォールバックにより `index.html` が配信される） |

### V: 動画プレイヤー

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| V-1 | 動画プレイヤーの表示 | video-1 の詳細ページ | 詳細ページを開く | `<video>` 要素が表示され、`controls` 属性を持つ |
| V-2 | デフォルト画質の選択 | video-1 の詳細ページ | 詳細ページを開く | 画質セレクタに `formats[0]` の画質名が表示される |
| V-3 | 画質切替 | video-1 の詳細ページ | 画質セレクタで別の画質を選択 | `<video>` の `<source>` src が選択した画質のファイルパスに変わる |
| V-4 | 画質セレクタのオプション | video-1 の詳細ページ | 画質セレクタを開く | 「1080p」「720p」が表示される |
| V-5 | 単一画質の場合 | video-2 の詳細ページ | 詳細ページを開く | 画質セレクタに「720p」のみ表示される |
| V-6 | 画質なし（空 formats）の場合 | video-3 の詳細ページ | 詳細ページを開く | プレイヤーがクラッシュせず表示される（注意: `formats[0]` が `undefined` のため要確認） |
| V-7 | 画質ラベルの表示 | video-1 の詳細ページ | 詳細ページを開く | 「画質」ラベルが表示される |

### D: 詳細ページ表示（空データ対応含む）

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| D-1 | 全フィールドが揃った動画の詳細表示 | video-1 の詳細ページ | 詳細ページを開く | タイトル、日付、外部リンク、出演者バッジ、タグバッジ、画像ギャラリーがすべて表示される |
| D-2 | 出演者が複数の場合 | video-1 の詳細ページ | 詳細ページを開く | 「出演者A」「出演者B」のバッジが表示される |
| D-3 | 出演者が1人の場合 | video-2 の詳細ページ | 詳細ページを開く | 「出演者C」のバッジのみ表示される |
| D-4 | 出演者が0人の場合 | video-3 の詳細ページ | 詳細ページを開く | 出演者セクションにバッジが表示されない |
| D-5 | 外部リンクの動作 | video-1 の詳細ページ | 「外部リンク」をクリック | `target="_blank"` かつ `rel="noopener noreferrer"` で新しいタブに開く |
| D-6 | 外部リンクが空の場合 | video-3 の詳細ページ | 詳細ページを開く | 外部リンクが表示されないか、空の URL として表示される |

### G: 画像ギャラリー・Lightbox

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| G-1 | 画像ギャラリーの表示（複数画像） | video-1 の詳細ページ、メディアファイル配置済み | 詳細ページを開く | 画像セクションに複数の画像がグリッド表示される |
| G-2 | 画像の alt 属性 | video-1 の詳細ページ | 詳細ページを開く | 各画像に `Picture 1`, `Picture 2`, ... の alt テキストが設定されている |
| G-3 | 画像クリックで Lightbox が開く | G-1 の状態 | 1枚目の画像をクリック | Lightbox が開き、拡大画像が表示される |
| G-4 | Lightbox を閉じる | G-3 の状態 | 閉じるボタンをクリック or Escape キーを押す | Lightbox が閉じる |
| G-5 | Lightbox で画像を切り替え | G-3 の状態 | 次へ/前へナビゲーションを使用 | 表示画像が切り替わる |
| G-6 | 画像が1枚の場合 | video-2 の詳細ページ | 詳細ページを開く | 画像が1枚だけ表示される |
| G-7 | 画像が0枚の場合 | video-3 の詳細ページ | 詳細ページを開く | 画像セクションに画像が表示されない |
| G-8 | 画像グリッドのレイアウト | video-1 の詳細ページ | 詳細ページを開く | 4列グリッド（`grid-cols-4`）で表示される |

### RT: 星評価

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| RT-1 | 評価未登録の初期状態 | テストデータ投入済み | 一覧ページで動画の評価ボタンを確認 | 5つの空の星ボタン（`aria-pressed="false"`）が表示される |
| RT-2 | 星をクリックして評価を設定（一覧ページ） | RT-1 の状態 | 星3をクリック | 星1-3が `aria-pressed="true"` になる |
| RT-3 | 同じ星をクリックして評価を解除（一覧ページ） | RT-2 の状態 | 同じ星3をクリック | 全ての星が `aria-pressed="false"` に戻る |
| RT-4 | 星をクリックして評価を設定（詳細ページ） | video-1 の詳細ページ | 星5をクリック | 星5が `aria-pressed="true"` になる |
| RT-5 | 評価状態の永続化 | RT-4 実行後 | ページをリロード | 評価状態が維持される |
| RT-6 | 星ボタンのクリックでページ遷移しない | テストデータ投入済み、一覧ページ | 星ボタンをクリック | 一覧ページのまま遷移しない |
| RT-7 | 詳細ページでの評価が一覧に反映される | 詳細ページで評価設定後 | 一覧ページに戻る | 評価状態が反映されている |

### HV: 動画フォーマットフィルタ

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| HV-1 | デフォルトでクラウドアイコンがOFF状態 | テストデータ投入済み | 一覧ページを表示 | `aria-label="動画のみ表示中"` のボタンが表示される |
| HV-2 | デフォルトでフォーマット付き動画のみ表示される | テストデータ投入済み | 一覧ページを表示 | video-1, video-2 のみ表示、video-3 は非表示 |
| HV-3 | クラウドアイコンをクリックするとONになり全動画が表示される | HV-1 の状態 | クラウドアイコンをクリック | `aria-label="全て表示中"` に変わり、video-3 も表示される |
| HV-4 | 再度クリックでOFFに戻り動画のみ表示 | HV-3 の状態 | クラウドアイコンをクリック | `aria-label="動画のみ表示中"` に戻り、video-3 が非表示になる |
| HV-5 | ON時にURLに `has_video=false` が反映される | HV-3 の状態 | URL を確認 | `has_video=false` がURLパラメータに含まれる |
| HV-6 | OFF時にURLに `has_video` パラメータがない | テストデータ投入済み | URL を確認 | `has_video` パラメータがない |
| HV-7 | `has_video=false` のURLから状態が復元される | − | `/?has_video=false` にアクセス | クラウドアイコンがON状態で全動画表示 |
| HV-8 | フィルタ変更時にページが1にリセットされる | 2ページ目を表示中 | クラウドアイコンをクリック | ページが1にリセットされる |

### SF: 星フィルタ

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| SF-1 | 星フィルタの初期状態 | テストデータ投入済み | 一覧ページを表示 | 5つの星が表示され、全て `aria-pressed="false"` |
| SF-2 | 星3をクリックすると rating >= 3 の動画のみ表示 | 評価データ設定済み | 星3をクリック | rating >= 3 の動画のみ表示される |
| SF-3 | 同じ星を再クリックでフィルタ解除 | SF-2 の状態 | 同じ星3をクリック | フィルタが解除され全動画が表示される |
| SF-4 | URLに `min_rating` パラメータが反映される | SF-2 の状態 | URL を確認 | `min_rating=3` がURLに含まれる |
| SF-5 | URL `?min_rating=3` からの状態復元 | − | `/?min_rating=3` にアクセス | 星1-3が `aria-pressed="true"` の状態で表示 |
| SF-6 | フィルタ変更時にページが1にリセットされる | 2ページ目を表示中 | 星フィルタを変更 | ページが1にリセットされる |

### T: テーマ切替（ダーク/ライト）

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| T-1 | テーマ切替ボタンの表示 | − | ページを開く | 右上に固定配置されたテーマ切替ボタンが表示される |
| T-2 | ダークモードに切替 | ライトモードの状態 | 「ダークモードに切替」ボタンをクリック | `<html>` 要素に `dark` クラスが追加される |
| T-3 | ライトモードに切替 | ダークモードの状態 | 「ライトモードに切替」ボタンをクリック | `<html>` 要素から `dark` クラスが削除される |
| T-4 | テーマの永続化 | T-2 実行後 | ページをリロード | ダークモードが維持される |
| T-5 | ダークモード時のアイコン | ダークモードの状態 | テーマ切替ボタンを確認 | 太陽アイコンが表示される（`aria-label="ライトモードに切替"`） |
| T-6 | ライトモード時のアイコン | ライトモードの状態 | テーマ切替ボタンを確認 | 月アイコンが表示される（`aria-label="ダークモードに切替"`） |
| T-7 | テーマ切替がページ遷移後も維持される | T-2 実行後 | 詳細ページに遷移 | ダークモードが維持される |

### U: URL 状態管理

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| U-1 | 検索クエリが URL に反映される | テストデータ投入済み | 検索バーに「テスト」を入力 | URL に `?q=テスト` が付与される |
| U-2 | タグフィルタが URL に反映される | テストデータ投入済み | タグフィルタで「タグ1」を選択 | URL に `tag=タグ1` が付与される |
| U-3 | 出演者フィルタが URL に反映される | テストデータ投入済み | 出演者フィルタで「出演者A」を選択 | URL に `actor=出演者A` が付与される |
| U-4 | URL パラメータからの状態復元 | − | `/?q=テスト&tag=タグ1&page=1` に直接アクセス | 検索バーに「テスト」、タグフィルタに「タグ1」が設定された状態で表示される |
| U-5 | 複数パラメータの同時 URL 反映 | テストデータ投入済み | 検索「テスト」、タグ「タグ1」、出演者「出演者A」を設定 | URL にすべてのパラメータが反映される |

### E: エッジケース

| ID | シナリオ | 前提条件 | 手順 | 期待結果 |
|----|---------|---------|------|---------|
| E-1 | データが0件の場合の一覧表示 | DB が空 | 一覧ページを表示 | 動画カードが表示されず、エラーにならない |
| E-2 | 特殊文字を含む検索 | テストデータ投入済み | 検索バーに `<script>alert(1)</script>` を入力 | XSS が発生せず、正常に検索される（結果0件） |
| E-3 | 長い検索クエリ | テストデータ投入済み | 検索バーに非常に長い文字列（100文字以上）を入力 | エラーにならず、正常に検索が実行される |
| E-4 | 不正なページ番号の URL | − | `/?page=0` や `/?page=-1` にアクセス | エラーにならず、1ページ目が表示される |

---

## シナリオ数サマリ

| ID | 機能領域 | シナリオ数 |
|----|---------|-----------|
| S | 検索 | 7 |
| F | フィルタリング（タグ・出演者） | 11 |
| C | 複合フィルタ | 6 |
| P | ページネーション | 6 |
| N | ナビゲーション・ページ遷移 | 5 |
| V | 動画プレイヤー | 7 |
| D | 詳細ページ表示 | 6 |
| G | 画像ギャラリー・Lightbox | 8 |
| RT | 星評価 | 7 |
| HV | 動画フォーマットフィルタ | 8 |
| SF | 星フィルタ | 6 |
| T | テーマ切替 | 7 |
| U | URL 状態管理 | 5 |
| E | エッジケース | 4 |
| **合計** | | **93** |
